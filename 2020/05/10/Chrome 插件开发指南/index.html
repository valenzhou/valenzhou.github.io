<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Chrome 插件开发指南 | Mr.喵的网络日志</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Chrome 插件开发指南开发与调试chrome插件没有严格的项目结构要求，只有保证本目录有一个 manifest.json 即可，从浏览器菜单-更多工具-扩展程序可以进入插件管理页面。或直接输入地址 chrome://extensions访问。 勾选开发者模式可以用文件夹的形式直接加载插件，否则只能安装.crx 格式的文件。mac 系统下插件安装目录为: ~/Library/Applicatio">
<meta name="keywords" content="chrome 插件">
<meta property="og:type" content="article">
<meta property="og:title" content="Chrome 插件开发指南">
<meta property="og:url" content="http://yoursite.com/2020/05/10/Chrome 插件开发指南/index.html">
<meta property="og:site_name" content="Mr.喵的网络日志">
<meta property="og:description" content="Chrome 插件开发指南开发与调试chrome插件没有严格的项目结构要求，只有保证本目录有一个 manifest.json 即可，从浏览器菜单-更多工具-扩展程序可以进入插件管理页面。或直接输入地址 chrome://extensions访问。 勾选开发者模式可以用文件夹的形式直接加载插件，否则只能安装.crx 格式的文件。mac 系统下插件安装目录为: ~/Library/Applicatio">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2021-08-30T09:48:58.468Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chrome 插件开发指南">
<meta name="twitter:description" content="Chrome 插件开发指南开发与调试chrome插件没有严格的项目结构要求，只有保证本目录有一个 manifest.json 即可，从浏览器菜单-更多工具-扩展程序可以进入插件管理页面。或直接输入地址 chrome://extensions访问。 勾选开发者模式可以用文件夹的形式直接加载插件，否则只能安装.crx 格式的文件。mac 系统下插件安装目录为: ~/Library/Applicatio">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
  
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  
</head>

  
    
      <body>
    
  
      <div id="container" class="container">
        <article id="post-Chrome 插件开发指南" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/categories">Categories</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Chrome 插件开发指南
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <h1 id="Chrome-插件开发指南"><a href="#Chrome-插件开发指南" class="headerlink" title="Chrome 插件开发指南"></a>Chrome 插件开发指南</h1><h3 id="开发与调试"><a href="#开发与调试" class="headerlink" title="开发与调试"></a>开发与调试</h3><p>chrome插件没有严格的项目结构要求，只有保证本目录有一个 <code>manifest.json</code> 即可，从<code>浏览器菜单-更多工具-扩展程序</code>可以进入插件管理页面。或直接输入地址 <a href="https://www.notion.so/chrome-extensions-09ff4f8b5fb448d7addd8727b9fa90cb" target="_blank" rel="external">chrome://extensions</a>访问。</p>
<p>勾选开发者模式可以用文件夹的形式直接加载插件，否则只能安装.crx 格式的文件。<br>mac 系统下插件安装目录为: <code>~/Library/Application Support/Google/Chrome/Default/Extensions</code></p>
<h3 id="核心介绍"><a href="#核心介绍" class="headerlink" title="核心介绍"></a>核心介绍</h3><ol>
<li><p>manifest.json</p>
<p> 用来配置插件相关的配置信息，必须放在根目录。且以下属性是必不可少的。完整属性可以查看<a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="external">官方文档</a>。</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"manifest_version"</span> : <span class="number">2</span>,</span><br><span class="line">	<span class="string">"name"</span> : <span class="string">"test"</span>,</span><br><span class="line">	<span class="string">"version"</span> : <span class="string">"1.0.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>content-scripts    (插件与页面交互)</p>
<p> 是 chrome 插件向页面注入脚本的一种形式,我们可以通过manifest.json配置轻易的向页面注入 js 和 css,最常见的是广告屏蔽,页面样式定制等等.</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"content-scripts"</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"matches"</span> : [<span class="string">"http://*/*"</span>, <span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">			<span class="string">"js"</span>: [<span class="string">"js/xxx.js"</span>,<span class="string">"....js"</span>],</span><br><span class="line">			<span class="string">"css"</span>: [<span class="string">"css/xx.css"</span>],</span><br><span class="line">			<span class="string">"run_at"</span>: <span class="string">"document_start"</span> <span class="comment">// 可选 document_start/end/idle(默认空闲)</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> content-scripts 与原始页面共享DOM，但不共享JS，如果想要访问页面JS某个变量，只能通过 injected js 来实现，content-scripts不能访问绝大部分chrome.xxx.api, 除了以下四种。</p>
<pre><code>- chrome.extension(getURL,inIncognitoContext, lastError,onRequest,sendRequest)
- chrome.i18N
- chrome.runtime(connect,getManifest,getURL,id, onConnect,onMessage,sendMessage)
- chrome.storage
</code></pre></li>
<li><p>background<br> 后台是一个常驻的页面,它随着浏览器的开关而开关.通常把需要一直运行的代码放在 background 里面.<br> 他的权限非常高,可以调用 chrome 的扩展 API(除了 devtools), 而且它可以无限制跨域.配置中,background 可以通过 page 指定一个页面,也可以通过 scripts 指定一个 js,chrome 会自动为这个 js 生成一个默认页面.</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"background"</span>:&#123;</span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"xxx.html"</span></span><br><span class="line">		<span class="comment">// scripts: ["js/xxx.js"]</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>event-pages<br> 鉴于 background 生命周期和浏览器同步,长时间挂载后台影响性能,而 event-pages 与 background 唯一的区别就是多了一个 persistent 参数,它会在需要时被加载,空闲时被关闭.一般 background 用的比较多.</p>
</li>
<li><p>popup<br> popup 是点击插件图标时打开的一个窗口网页,焦点离开网页就关闭,一般做一些交互使用.<br> popup 可以包含任意你想要的 HTML,并且会自适应大小,可以通过 default_popup 来指定页面,也可以调用 setPopup()方法.</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"browser_action"</span> : &#123;</span><br><span class="line">	<span class="string">"default_icon"</span>: <span class="string">"img/xx.png"</span>,</span><br><span class="line">	<span class="string">"default_title"</span>: <span class="string">"悬停时的标题"</span>,</span><br><span class="line">	<span class="string">"default_popup"</span>: <span class="string">"xx.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> popup 的生命和周期很短,需要长时间运行的代码不要放在 popup 里.popup 中可以通过 chrome.extension.getBackgroundPage() 获取 background 的 window 对象.</p>
</li>
<li><p>injected-script<br> content-script 无法访问页面中的 js,虽然它可以操作 dom,但 dom 却不能调用它,也就是在 dom 的事件中无法调用 content-script 中的代码,但是在页面中添加一个按钮并调用插件的 api 是很常见的需求,我们可以再 content-script 中通过 DOM 方式向页面注入 inject-script.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content-script</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectCustomJs</span>(<span class="params">jsPath</span>)</span>&#123;</span><br><span class="line">	jsPath = jsPath || <span class="string">'js/inject.js'</span>;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="built_in">document</span>.creatElement(<span class="string">"script"</span>);</span><br><span class="line">	temp.src = chrome.extension.getURL(jsPath); <span class="comment">// 类似于 chrome-extension://xxxx/js/inject.js</span></span><br><span class="line">	temp.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.parentNode.removeChild(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">document</span>.head.appendChild(temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  代码会报错,因为在 web 中直接访问插件中的资源必须显示声明才行,在配置文件中增加以下配置:</p>
  <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 普通页面能够直接访问的插件资源列表,不设置无法直接访问.</span></span><br><span class="line">	<span class="string">"web_accessible_resources"</span>: [<span class="string">"js/inject.js"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  inject-script 如何调用 content-script 中的代码,要用到消息通信.</p>
</li>
<li><p>homepage_url<br> 开发者网站</p>
</li>
</ol>
<h3 id="Chrome-插件的-8-种展示形式"><a href="#Chrome-插件的-8-种展示形式" class="headerlink" title="Chrome 插件的 8 种展示形式"></a>Chrome 插件的 8 种展示形式</h3><ol>
<li><p>browserAction 浏览器右上角图标</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"browser_action"</span> : &#123;</span><br><span class="line">		<span class="string">"default_icon"</span>: <span class="string">"img/xx.png"</span>, <span class="comment">// 19*19 </span></span><br><span class="line">		<span class="string">"default_title"</span>: <span class="string">"悬停时的标题"</span>,</span><br><span class="line">		<span class="string">"default_popup"</span>: <span class="string">"xx.html"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 通过 setIcon 更改 icon, setTitle()更改鼠标 hover 时的标题.setBadgeText()来更改图标上的文本信息.</p>
</li>
<li><p>pageAction 地址栏右侧<br> 当某些特定页面打开时会在地址栏右边显示的图标.(新版吧位置放到了浏览器右边,可以把它看成置灰的 browserAction.<br> 例如当打开百度时才显示图标.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.runtime.onInstalled.addListener(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	chrome.declarativeContent.onPageChanged.removeRules(<span class="literal">undefined</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		chrome.declarativeContent.onPageChanged.addRules([</span><br><span class="line">			&#123;</span><br><span class="line">				conditions: [</span><br><span class="line">					<span class="comment">// 只有打开百度才显示pageAction</span></span><br><span class="line">					<span class="keyword">new</span> chrome.declarativeContent.PageStateMatcher(&#123;<span class="attr">pageUrl</span>: &#123;<span class="attr">urlContains</span>: <span class="string">'baidu.com'</span>&#125;&#125;)</span><br><span class="line">				],</span><br><span class="line">				actions: [<span class="keyword">new</span> chrome.declarativeContent.ShowPageAction()]</span><br><span class="line">			&#125;</span><br><span class="line">		]);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>右键菜单<br> 通过 chrome.contextMenus API,右键菜单可以出现在不同的上下文.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;<span class="string">"permissions"</span>: [<span class="string">"contextMenus"</span>]&#125;</span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.contextMenus.create(&#123;</span><br><span class="line">	title: <span class="string">"测试右键菜单"</span>,</span><br><span class="line">	onclick: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'您点击了右键菜单！'</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p> <a href="https://developer.chrome.com/extensions/contextMenus" target="_blank" rel="external">常见 API 参考</a> </p>
</li>
<li><p>覆盖特定页面<br> 使用 override 页可以将 chrome 默认的一些特定页面替换掉.一个插件只能替代一个默认页.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"chrome_url_overrides"</span>:</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"newtab"</span>: <span class="string">"newtab.html"</span>,</span><br><span class="line">	<span class="string">"history"</span>: <span class="string">"history.html"</span>,</span><br><span class="line">	<span class="string">"bookmarks"</span>: <span class="string">"bookmarks.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>devtools(开发者工具)<br> 例如 vue.js devtools , chrome 可以再 devtools 上新增一个面板.<br> devtools 页面会随着开发者工具的开关而开关.可以访问 Devtools API ,而其他比如 background 无权访问.</p>
<ul>
<li>chrome.devtools.panels: 面板相关</li>
<li>chrome.devtools.inspectedWindow: 获取被审查窗口的信息</li>
<li><p>chrome.devtools.network: 获取有关网络请求的信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"devtools_page"</span>: <span class="string">"XXX.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 html 一般什么都没有,只有一个 script 标签引用 js 文件<code>&lt;script src=&#39;js/devtools.js&#39;&gt;&lt;/script&gt;</code>,<br>再看一下 devtools 的代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建自定义面板，同一个插件可以创建多个自定义面板</span></span><br><span class="line"><span class="comment">// 几个参数依次为：panel标题、图标（其实设置了也没地方显示）、要加载的页面、加载成功后的回调</span></span><br><span class="line">chrome.devtools.panels.create(<span class="string">'MyPanel'</span>, <span class="string">'img/icon.png'</span>, <span class="string">'mypanel.html'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">panel</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'自定义面板创建成功！'</span>); <span class="comment">// 注意这个log一般看不到</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 创建自定义侧边栏</span></span><br><span class="line">chrome.devtools.panels.elements.createSidebarPane(<span class="string">"Images"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">sidebar</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// sidebar.setPage('../sidebar.html'); // 指定加载某个页面</span></span><br><span class="line">	sidebar.setExpression(<span class="string">'document.querySelectorAll("img")'</span>, <span class="string">'All Images'</span>); <span class="comment">// 通过表达式来指定</span></span><br><span class="line">	<span class="comment">//sidebar.setObject(&#123;aaa: 111, bbb: 'Hello World!'&#125;); // 直接设置显示某个对象</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 访问被检查的页面DOM需要使用inspectedWindow</span></span><br><span class="line">chrome.devtools.inspectedWindow.eval(<span class="string">"jQuery.fn.jquery"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">result, isException</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> html = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">if</span> (isException) html = <span class="string">'当前页面没有使用jQuery。'</span>;</span><br><span class="line">	<span class="keyword">else</span> html = <span class="string">'当前页面使用了jQuery，版本为：'</span>+result;</span><br><span class="line">	alert(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>选项页 option<br> 选项页是插件的设置页面,有两个入口,一个是右键图标菜单,一个是插件管理页面.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">//	"options_page": "options.html" ,(老版本写法)</span></span><br><span class="line">	<span class="string">"options_ui"</span>: &#123;</span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"optionxxx.html"</span>,</span><br><span class="line">		<span class="string">"open_in_tab"</span>: <span class="literal">true</span>, <span class="comment">// 在当前 tab 打开</span></span><br><span class="line">		<span class="string">"chrome_style"</span>: <span class="literal">true</span> <span class="comment">//  添加了一些默认样式</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 不能使用 alert, 数据存储建议使用 chrome.storage, 因为会随用户自动同步</p>
</li>
<li><p>omnibox<br> 注册某个关键字触发插件自己的搜索建议界面.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 向地址栏注册一个关键字以提供搜索建议，只能设置一个关键字</span></span><br><span class="line">	<span class="string">"omnibox"</span>: &#123; <span class="string">"keyword"</span> : <span class="string">"go"</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 然后在 background 注册监听事件:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">chrome.omnibox.onInputChanged.addListener(<span class="function">(<span class="params">text, suggest</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'inputChanged: '</span> + text);</span><br><span class="line">	<span class="keyword">if</span>(!text) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(text === <span class="string">'xxx'</span>)&#123;</span><br><span class="line">		suggest([</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'百度搜索 '</span> + text, <span class="attr">description</span>: <span class="string">'百度搜索 '</span> + text&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'谷歌搜索 '</span> + text, <span class="attr">description</span>: <span class="string">'谷歌搜索 '</span> + text&#125;,</span><br><span class="line">		]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>桌面通知:<br> chrome 提供了一个 chrome.notification API 方便插件推送桌面通知.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chrome.notifications.create(<span class="literal">null</span>,&#123;</span><br><span class="line">	type: <span class="string">"basic"</span>,</span><br><span class="line">	iconUrl: <span class="string">"img/xx.ping"</span>,</span><br><span class="line">	title: <span class="string">"标题"</span>,</span><br><span class="line">	message: <span class="string">"内容"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h3><ul>
<li><p>popup 和 background<br>  popup 可以直接调用 background 的 js 方法,也可以访问 background 的 DOM.</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// background.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	alert(<span class="string">"background"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// popup.js</span></span><br><span class="line"><span class="keyword">var</span> bg = chrome.extension.getBackgroundPage();</span><br><span class="line">bg.test();</span><br><span class="line">bg.document.body.innerHTML; <span class="comment">// dom</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>popup 或 bg 向 content 发消息</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bg,popup.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendMessageToContent</span>(<span class="params">message,callback</span>)</span>&#123;</span><br><span class="line">	chrome.tabs.query(&#123;<span class="attr">active</span>:<span class="literal">true</span>,<span class="attr">currentWindow</span>: <span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span>&#123;</span><br><span class="line">		chrome.tabs.sendMessage(tabs[<span class="number">0</span>].id,message,<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(callback) callback(res);</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// content-script.js 接收</span></span><br><span class="line">chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">req,send,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.cmd == <span class="string">'test'</span>) alert(req.value);</span><br><span class="line">	send(<span class="string">"我收到了你的消息"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>content 向 bg/popup 主动发消息</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content-script.js</span></span><br><span class="line">chrome.runtime.sendMessage(&#123;</span><br><span class="line">	greeting: <span class="string">"hello"</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"收到回复"</span> + res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// bg 或 popup.js</span></span><br><span class="line">chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">req,send,res</span>)</span>&#123;</span><br><span class="line">	send(<span class="string">"我收到了你的消息"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>injected script 和 content script<br>  content-script 和页面内 脚本(injected-script)之间唯一共享的就是页面 DOM 元素.有两种方式实现通信,一是通过 window.postMessage 和 window.addEventListener 实现消息通信(推荐),二是通过 自定义 dom 事件.</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// injected - script</span></span><br><span class="line"><span class="built_in">window</span>.postMessage(&#123;<span class="string">"test"</span>: <span class="string">'hello'</span>&#125;,<span class="string">'*'</span>);</span><br><span class="line"><span class="comment">// content- script</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e.data)</span><br><span class="line">&#125;,<span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>长连接和短连接<br>chrome 插件中有两种通信方式,一种是短连接(chrome.tabs.sendMessage和 chrome.runtime.sendMessage),一个是长连接(chrome.tabs.connect 和 chrome.runtime.connect).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 长连接</span></span><br><span class="line"><span class="comment">// popup.js</span></span><br><span class="line"><span class="keyword">var</span> port = chrome.tabs.connect(tabId,&#123;<span class="attr">name</span>: <span class="string">'test-connect'</span>&#125;);</span><br><span class="line">port.postMessage(&#123;<span class="attr">xxx</span>:<span class="string">'xxx'</span>&#125;);</span><br><span class="line">port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">	alert(<span class="string">'收到消息'</span> + msg.answer)</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// content-script</span></span><br><span class="line">chrome.runtime.onConnect.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">port</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(port === <span class="string">'test-connect'</span>)&#123;</span><br><span class="line">		port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">			alert(<span class="string">"收到长连接"</span>,msg)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ul>
<li><p>获取当前窗口 id</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome.windows.getCurrent(<span class="function"><span class="keyword">function</span>(<span class="params">cw</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(cw.id)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取当前标签页 id</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTabId</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">	chrome.tabs.query(&#123;<span class="attr">active</span>:<span class="literal">true</span>,<span class="attr">currentWindow</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(callback) callback(tabs.length ? tabs[<span class="number">0</span>].id : <span class="literal">null</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定期执行代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置</span></span><br><span class="line"><span class="string">"permissions"</span>: [<span class="string">"alarms"</span>]</span><br><span class="line"><span class="comment">// 创建方法</span></span><br><span class="line">chrome.alarms.create(name,info);<span class="comment">// name 为任务名, info 包含以下属性 when 何时,dalayInMinutes 延迟时间, periodInMinutes 非 null表示时间间隔,单位 min</span></span><br><span class="line">chrome.alarms.onAlarm.addListener(xxx); <span class="comment">// 触发事件</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本地存储<br>chrome.storage 是针对插件全局的,即使在 background 中保存的数据,在 content-script 也能获取到.chrome.storage.sync 可以跟随当前登录用户自动同步.需要声明 storage 权限,有 sync 和 local 两种方式选择.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取数据,第一个参数是要读取的 key 以及默认值</span></span><br><span class="line">chrome.storage.sync.get(&#123;<span class="attr">color</span>: <span class="string">'red'</span>,<span class="attr">age</span>:<span class="number">18</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">items</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(items)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 保存数据</span></span><br><span class="line">chrome.storage.sync(&#123;<span class="attr">color</span>:<span class="string">'blue'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'save success'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>快捷键唤醒 popup</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"commands"</span>: &#123;</span><br><span class="line">	<span class="string">"_execute_browser_action"</span>:&#123;</span><br><span class="line">		<span class="string">"suggested_key"</span>:&#123;</span><br><span class="line">			<span class="string">"default"</span>: <span class="string">"Alt+Shift+J"</span>  <span class="comment">// 快捷键唤醒</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>webRequest<br>通过 webrequest API 可以对 HTTP 请求进行修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//权限申请</span></span><br><span class="line"><span class="string">"permissions"</span>: [</span><br><span class="line">	<span class="string">"webRequest"</span>, <span class="comment">// web请求</span></span><br><span class="line">	<span class="string">"webRequestBlocking"</span>, <span class="comment">// 阻塞式 web 请求</span></span><br><span class="line">	<span class="string">"storage"</span>,<span class="comment">// 插件本地储存</span></span><br><span class="line">	<span class="string">"http://*/*"</span> <span class="comment">//可以通过 executeScript 或 insertCss 访问的网站</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// web 请求监听</span></span><br><span class="line">chrome.webRequest.onBeforeRequest.addListener(<span class="function"><span class="params">details</span> =&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">let</span> showImage = <span class="literal">false</span> ; <span class="comment">// 不展示图片</span></span><br><span class="line">	<span class="keyword">if</span>(!showImage &amp;&amp; details.type === <span class="string">'image'</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			cancel: <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(details.type === <span class="string">'media'</span>)&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;,&#123;<span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]&#125;,[<span class="string">"blocking"</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>国际化<br>插件根目录新建一个_locales 的文件夹,在新建一些语言文件夹如 en,zh_CN,zh_TW,然后在每个语言文件夹放入一个 messages.json,同时在文件中设置 default_locale.测试时，通过给chrome建立一个不同的快捷方式chrome.exe –lang=en来切换语言</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// en/message.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"pluginDesc"</span>: &#123;<span class="string">"message"</span>: <span class="string">"A simple chrome extension demo"</span>&#125;,</span><br><span class="line">	<span class="string">"helloWorld"</span>: &#123;<span class="string">"message"</span>: <span class="string">"Hello World!"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// zh_CN/message.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"pluginDesc"</span>: &#123;<span class="string">"message"</span>: <span class="string">"一个简单的Chrome插件demo"</span>&#125;,</span><br><span class="line">	<span class="string">"helloWorld"</span>: &#123;<span class="string">"message"</span>: <span class="string">"你好啊，世界！"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在 manifest.json 和 css 文件中通过 __MSG_messagename__引入</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"description"</span>: <span class="string">"__MSG_pluginDesc__"</span>,</span><br><span class="line">	<span class="comment">// 默认语言</span></span><br><span class="line">	<span class="string">"default_locale"</span>: <span class="string">"zh_CN"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// js 中使用</span></span><br><span class="line">chrome.i18n.getMessage(<span class="string">"helloWorld"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2020/05/10/Chrome 插件开发指南/" class="article-date">
  <time datetime="2020-05-10T03:47:49.000Z" itemprop="datePublished">2020-05-10</time>
</a>

        </li>
        
          <li>
            <span class="label">Category:</span>
            
  <div class="article-category">
    <a class="article-category-link" href="/categories/前端/">前端</a>
  </div>


          </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chrome-插件/">chrome 插件</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2020/06/15/读<<上帝的骰子>>/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          读&lt;&lt;上帝的骰子&gt;&gt;
        
      </div>
    </a>
  
  
    <a href="/2020/04/11/solidity 区块链编程入门/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">solidity 区块链编程入门</div>
    </a>
  
</nav>


  
</article>






      </div>
      
    <footer id="footer" class="post-footer footer">
      
        <ul class="footer-links">
          
            <li><a href="/archives/"><span class="fa fa-book"></span></a></li>
          
            <li><a href="https://github.com/valenzhou"><span class="fa fa-github-alt"></span></a></li>
          
            <li><a href="https://www.facebook.com/valen.zhou"><span class="fa fa-facebook"></span></a></li>
          
            <li><a href="https://twitter.com/valenzhou/"><span class="fa fa-twitter"></span></a></li>
          
            <li><a href="https://plus.google.com/"><span class="fa fa-google-plus"></span></a></li>
          
            <li><a href="https://www.google.com/"><span class="fa fa-globe"></span></a></li>
          
            <li><a href="/atom.xml"><span class="fa fa-rss"></span></a></li>
          
        </ul>
	    
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>ipsum dolor sit amet, <strong>consectetur adipiscing elit.</strong> Fusce eget urna vitae velit <em>eleifend interdum at ac nisi. In nec ligula lacus. Cum sociis natoque</em> penatibus et magnis dis parturient montes, nascetur ridiculus mus. Sed eu cursus erat, ut dapibus quam. Post</p>


      </div>
    </footer>

      



<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
